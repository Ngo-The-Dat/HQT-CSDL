USE MASTER 
GO
--DROP DATABASE KHOHANG
CREATE DATABASE KHOHANG
GO
USE KHOHANG
GO

CREATE TABLE SANPHAM 
(
	MASP VARCHAR(5) PRIMARY KEY,
	TENSP NVARCHAR(50),
	GIA FLOAT CHECK(GIA >= 0),
	TONKHO INT CHECK(TONKHO >= 0)
) 

CREATE TABLE DONHANG
(
	MADH VARCHAR(5) PRIMARY KEY, 
	NGAYDAT DATE CHECK (NGAYDAT <= GETDATE()), 
	TONGTIEN FLOAT DEFAULT 0, 
	MANV VARCHAR(5)
)

CREATE TABLE CHITIETDONHANG
(
	MADH VARCHAR(5), 
	MASP VARCHAR(5), 
	SOLUONG INT CHECK(SOLUONG > 0), 
	THANHTIEN FLOAT

	PRIMARY KEY(MADH, MASP)
)

CREATE TABLE NHANVIEN
(
	MANV VARCHAR(5) PRIMARY KEY, 
	HOTEN NVARCHAR(50), 
	CHUCVU NVARCHAR(50)
)
GO

ALTER TABLE DONHANG ADD CONSTRAINT FK_MANV FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)

ALTER TABLE CHITIETDONHANG ADD CONSTRAINT FK_MADH FOREIGN KEY(MADH) REFERENCES DONHANG(MADH)

ALTER TABLE CHITIETDONHANG ADD CONSTRAINT FK_MASP FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)

-- Thêm nhân viên
INSERT INTO NHANVIEN (MANV, HOTEN, CHUCVU)
VALUES
('NV01', N'Nguyễn Văn An', N'Bán hàng'),
('NV02', N'Lê Thị Bình', N'Kế toán'),
('NV03', N'Trần Văn Cường', N'Quản lý');
GO

-- Thêm sản phẩm
INSERT INTO SANPHAM (MASP, TENSP, GIA, TONKHO)
VALUES
('SP01', N'Chuột không dây', 250000, 100),
('SP02', N'Bàn phím cơ', 800000, 50),
('SP03', N'Màn hình 24 inch', 3200000, 20),
('SP04', N'Tai nghe Bluetooth', 450000, 60);
GO

-- Thêm đơn hàng
INSERT INTO DONHANG (MADH, NGAYDAT, TONGTIEN, MANV)
VALUES
('DH01', '2025-10-15', 0, 'NV01'),
('DH02', '2025-10-16', 0, 'NV02');
GO

-- Thêm chi tiết đơn hàng
INSERT INTO CHITIETDONHANG (MADH, MASP, SOLUONG)
VALUES
('DH01', 'SP01', 2),
('DH01', 'SP02', 1),
('DH02', 'SP03', 1),
('DH02', 'SP04', 2);
GO

CREATE PROCEDURE ThemChiTietDonHang
    @MADH VARCHAR(5),
    @MASP VARCHAR(5),
    @SOLUONG INT
AS
BEGIN
    BEGIN TRAN

    DECLARE @GIA FLOAT
    DECLARE @TONKHO INT
    DECLARE @THANHTIEN FLOAT

    -- Lấy giá và tồn kho hiện tại
    SELECT @GIA = GIA, @TONKHO = TONKHO
    FROM SANPHAM
    WHERE MASP = @MASP

    -- Kiểm tra tồn kho đủ không
    IF @TONKHO < @SOLUONG
    BEGIN
        PRINT N'Lỗi: Số lượng tồn kho không đủ!'
        ROLLBACK TRAN
        RETURN
    END

    -- Tính thành tiền
    SET @THANHTIEN = @SOLUONG * @GIA

    -- Thêm chi tiết đơn hàng
    INSERT INTO CHITIETDONHANG (MADH, MASP, SOLUONG, THANHTIEN)
    VALUES (@MADH, @MASP, @SOLUONG, @THANHTIEN)
	IF (@@ERROR != 0)
	BEGIN
		PRINT N'Lỗi: Thêm chi tiết đơn hàng!'
        ROLLBACK TRAN
        RETURN
	END

    -- Cập nhật tồn kho
    UPDATE SANPHAM
    SET TONKHO = TONKHO - @SOLUONG
    WHERE MASP = @MASP
	IF (@@ERROR != 0)
	BEGIN
		PRINT N'Lỗi: Cập nhật tồn kho sản phẩm!'
        ROLLBACK TRAN
        RETURN
	END

    -- Cập nhật tổng tiền đơn hàng
    UPDATE DONHANG
    SET TONGTIEN = (
        SELECT SUM(THANHTIEN)
        FROM CHITIETDONHANG
        WHERE MADH = @MADH
    )
    WHERE MADH = @MADH
	IF (@@ERROR != 0)
	BEGIN
		PRINT N'Lỗi: Cập nhật tổng tiền sản phẩm!'
        ROLLBACK TRAN
        RETURN
	END

    COMMIT TRAN
    PRINT N'Thêm chi tiết đơn hàng thành công!'
END

