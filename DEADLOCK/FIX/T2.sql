USE KHOHANG
GO
DECLARE @RETRY INT = 0
WHILE @RETRY < 3
BEGIN
	BEGIN TRY
		BEGIN TRAN
			UPDATE SANPHAM SET TONKHO = 1 WHERE MASP = 'SP01'
			PRINT N'UPDATE XONG'
			WAITFOR DELAY '00:00:05'
			PRINT N'WAIT XONG'
			UPDATE NHANVIEN SET CHUCVU = 'XYZ' WHERE HOTEN = N'Nguyễn Văn An'
		COMMIT TRAN
		BREAK
	END TRY
	
	BEGIN CATCH
	IF ERROR_NUMBER() = 1205
		BEGIN
			PRINT N'DEADLOCK => ROLLBACK'
			ROLLBACK TRAN
			SET @RETRY += 1
			WAITFOR DELAY '00:00:04'
		END
		ELSE
		BEGIN
			ROLLBACK TRAN
			THROW
		END
	END CATCH
END
PRINT N'THUC HIEN THANH CONG'